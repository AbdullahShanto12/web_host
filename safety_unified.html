

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SafeWay â€” Unified Map & Ratings</title>


      <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Styles (AdminLTE & DataTables) -->
  <link rel="stylesheet" href="plugins/bootstrap/css/bootstrap.min.css" />
  <link rel="stylesheet" href="dist/css/adminlte.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />


    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700">
    <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
    <link rel="stylesheet" href="dist/css/adminlte.min.css">
    <link rel="stylesheet" href="plugins/overlayScrollbars/css/OverlayScrollbars.min.css">



  <!-- Bootstrap + AdminLTE (as in your page) -->
  <link rel="stylesheet" href="plugins/bootstrap/css/bootstrap.min.css" />
  <link rel="stylesheet" href="dist/css/adminlte.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>

  <!-- Leaflet & Plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />



  <!-- Custom CSS -->
  <style>
  /* Base body */
  body {
    background: linear-gradient(135deg, #e0f0ff 0%, #ffffff 100%);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #223344;
  }

  /* Navbar */
  .main-header.navbar {
    background: #004085;
    color: white;
    font-weight: 600;
    box-shadow: 0 3px 8px rgba(0, 64, 133, 0.3);
  }

  .main-header.navbar .nav-link,
  .main-header.navbar .nav-icon {
    color: #cce0ff;
    transition: color 0.3s ease;
  }

  .main-header.navbar .nav-link:hover {
    color: #ffffff;
  }

  /* Sidebar */
  .main-sidebar {
    background-color: rgb(28, 31, 34);
    color: #ffffff;
  }

  .main-sidebar .brand-link {
    background-color: rgb(34, 38, 43);
    color: #ffffff;
    font-weight: bold;
    border-bottom: 1px solid #003366;
  }

  .main-sidebar .nav-link {
    color: #cfd9ff;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .main-sidebar .nav-link .nav-icon {
    color: #a0b8ff;
  }

  .main-sidebar .nav-link.active,
  .main-sidebar .nav-link:hover {
    background-color: #e6f0ff;
    color: #001f3f;
    font-weight: bold;
    border-radius: 8px;
  }

  .main-sidebar .nav-link.active .nav-icon,
  .main-sidebar .nav-link:hover .nav-icon {
    color: #001f3f;
  }

  /* Content Wrapper */
  .content-wrapper {
    background: #fdfefe;
    padding: 40px 35px 60px;
    min-height: calc(100vh - 56px);
  }

  /* Headings */
  h3, h5 {
    border-bottom: 4px solid #0056b3;
    padding-bottom: 12px;
    margin-bottom: 30px;
    font-weight: 800;
    color: #003366;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  /* Card */
  .card {
    border-radius: 15px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    border: none;
  }

  .card .card-body {
    padding: 2rem;
  }

  /* Stats Cards */
  .stats-card {
    text-align: center;
    padding: 20px;
    border-radius: 15px;
    color: white;
    font-weight: bold;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    transition: transform 0.2s ease;
  }
  .stats-card:hover {
    transform: translateY(-5px);
  }

  .bg-info {
    background-color:rgb(31, 191, 219) !important; /* Stronger royal blue */
  color: #FFFFFF !important;
  text-shadow: 0 1px 3px rgba(0,0,0,0.4);
}

.bg-success {
  background-color: #28A745 !important; /* Bootstrapâ€™s classic green */
  color: #FFFFFF !important;
  text-shadow: 0 1px 3px rgba(0,0,0,0.35);
}

.bg-danger {
  background-color: #DC3545 !important; /* Bootstrapâ€™s rich red */
  color: #FFFFFF !important;
  text-shadow: 0 1px 3px rgba(0,0,0,0.4);
}


  /* Map Styling */
  #map {
    height: 550px;
    width: 100%;
    border-radius: 15px;
    border: 3px solid #004085;
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.15);
    transition: box-shadow 0.3s ease;
  }

  #map:hover {
    box-shadow: 0 18px 45px rgba(0, 0, 0, 0.25);
  }

  /* Table */
  table.dataTable thead th {
    background-color: #004085 !important;
    color: white !important;
    font-weight: 700;
  }

  table.dataTable.no-footer {
    border-radius: 15px;
    border: 3px solid #004085;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  }

  /* Table Container */
  .table-container h5 {
    margin-top: 40px;
    margin-bottom: 20px;
    color: #003366;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .stats-card {
      margin-bottom: 20px;
    }
  }






    #map { height: 560px; border-radius: 10px; }
    .legend {
      background: white; padding: 8px 10px; line-height: 1.2; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,.15); font-size: 13px;
    }
    .legend i { width: 12px; height: 12px; display: inline-block; margin-right: 6px; border-radius: 3px; }
    .stats-card small { opacity: .9; }
    .leaflet-bar button { background: #fff; border: none; width: 34px; height: 34px; line-height: 34px; cursor: pointer; }
    .leaflet-bar button:focus { outline: none; }
    .dark-mode { background: #0d1117; color: #e6edf3; }
    .dark-mode .card { background: #161b22; color: #e6edf3; }




    


</style>





</head>




<body class="hold-transition sidebar-mini layout-fixed">
  <div class="wrapper">
    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <a href="dashboard.html" class="nav-link">Home</a>
        </li>
      </ul>
    </nav>

    <!-- Sidebar -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
  <a href="dashboard.html" class="brand-link">
    <img src="dist/img/AdminLTELogo.png" alt="Logo" class="brand-image img-circle elevation-3">
    <span class="brand-text font-weight-light">SafeWay</span>
  </a>
  <div class="sidebar">
    <nav class="mt-2">
      <ul class="nav nav-pills nav-sidebar flex-column" role="menu">
        <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="nav-icon fas fa-tachometer-alt"></i><p>Dashboard</p></a></li>
        <li class="nav-item"><a href="location_search.html" class="nav-link"><i class="nav-icon fas fa-shield-alt"></i><p>Safety Control Center</p></a></li>
        <li class="nav-item"><a href="safety_unified.html" class="nav-link active"><i class="nav-icon fas fa-map-marked-alt"></i><p>Unified Safety Explorer</p></a></li>
        <li class="nav-item"><a href="identify_routes.html" class="nav-link"><i class="nav-icon fas fa-route"></i><p>Identify Safer Routes</p></a></li>
        <li class="nav-item"><a href="filter_incidents.html" class="nav-link"><i class="nav-icon fas fa-exclamation-triangle"></i><p>Incidents & Hotspots</p></a></li>
        <li class="nav-item"><a href="community_resources.html" class="nav-link"><i class="nav-icon fas fa-hands-helping"></i><p>Community Resources</p></a></li>
        <li class="nav-item"><a href="legend_info.html" class="nav-link "><i class="nav-icon fas fa-map"></i><p>Using the Legend</p></a></li>
        <li class="nav-item"><a href="send_notifications.html" class="nav-link"><i class="nav-icon fas fa-bell"></i><p>Send Notifications</p></a></li>
        <li class="nav-item"><a href="all_notifications.html" class="nav-link"><i class="nav-icon fas fa-bell"></i><p>All Notifications</p></a></li>
        <li class="nav-item"><a href="emergency_calls.html" class="nav-link"><i class="nav-icon fas fa-phone-alt"></i><p>Emergency Calls</p></a></li>
        <li class="nav-item"><a href="login.html" class="nav-link"><i class="nav-icon fas fa-sign-out-alt"></i><p>Logout</p></a></li>
      </ul>
    </nav>
  </div>
</aside>



<!-- Content -->
<div class="content-wrapper p-3">
  <div class="container-fluid">

    <!-- Header -->
    <header class="text-center py-2 mb-3">
      <h3>ðŸ”Ž Unified Map Exploration & Visual Safety Ratings</h3>
      <div id="liveClock" class="text-muted"></div>
    </header>

    <!-- Stats (now filled by JS) -->
    <div class="row text-white mb-3">
      <div class="col-md-4">
        <div class="stats-card bg-info p-3 rounded shadow text-center">
          <h3 id="stat-total">0</h3>
          <small>Total Resources</small>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stats-card bg-success p-3 rounded shadow text-center">
          <h3 id="stat-categories">0</h3>
          <small>Unique Area Type</small>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stats-card bg-danger p-3 rounded shadow text-center">
          <h3 id="stat-distinct">0</h3>
          <small>Distinct Location</small>
        </div>
      </div>
    </div>

    <!-- Search / Filter / Dark Mode -->
    <div class="d-flex flex-wrap gap-2 align-items-end mb-3">
      <div class="me-2">
        <label class="form-label mb-1">Search</label>
        <input type="text" id="search-input" class="form-control" placeholder="e.g., Gulshan 2, Mirpur..." />
      </div>
      <div class="me-2">
        <label class="form-label mb-1">Filter by Safety</label>
        <select id="filter-select" class="form-select">
          <option value="all">All</option>
          <option value="High">High</option>
          <option value="Moderate">Moderate</option>
          <option value="Low">Low</option>
        </select>
      </div>
      <div class="me-2">
        <button id="apply-filter" class="btn btn-primary">Apply</button>
        <button id="reset-filter" class="btn btn-secondary">Reset</button>
      </div>
      <div class="ms-auto">
        <button id="dark-mode-toggle" class="btn btn-outline-dark">Toggle Dark Mode</button>
      </div>
    </div>

    <!-- Map -->
    <div id="map" class="mb-4"></div>

    <!-- Safety Ratings Table -->
    <div class="card">
      <div class="card-body">
        <h5 class="mb-2">Detailed Safety Ratings Table</h5>
        <table id="ratingsTable" class="display nowrap table table-bordered table-hover" style="width:100%">
          <thead class="thead-dark">
            <tr>
              <th>Location</th>
              <th>Latitude</th>
              <th>Longitude</th>
              <th>Area Type</th>
              <th>Reported Incidents</th>
              <th>Safety Rating</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="ratingsTbody"><tr><td colspan="7">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- Scripts -->
<script src="plugins/jquery/jquery.min.js"></script>
<script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="dist/js/adminlte.min.js"></script>

<!-- Leaflet & Plugins -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script>
/* =========================================================
   1) LocalStorage â€œDBâ€ (safety_locations) + seed data
   ========================================================= */
const LS_KEY = "safety_locations";

// Seed if empty â€” structure mirrors your MySQL schema
(function seedIfEmpty() {
  if (!localStorage.getItem(LS_KEY)) {
    const seed = [
      {
        id: 1,
        location: "Gulshan 2",
        latitude: 23.7925,
        longitude: 90.4078,
        area_type: "Commercial",
        reported_incidents: 3,
        safety_rating: "High",
        notes: "Corporate area; heavy security.",
        patrolling: "Frequent",
        street_lighting: "Good",
        women_helpline: "109",
        transport_access: "Excellent",
        description: "Embassies & offices.",
        last_updated: new Date().toISOString()
      },
      {
        id: 2,
        location: "Dhanmondi 27",
        latitude: 23.7465,
        longitude: 90.3760,
        area_type: "Residential",
        reported_incidents: 8,
        safety_rating: "Moderate",
        notes: "Pickpocketing hotspots at peak hours.",
        patrolling: "Regular",
        street_lighting: "Good",
        women_helpline: "109",
        transport_access: "Good",
        description: "Shops, eateries, parks.",
        last_updated: new Date().toISOString()
      },
      {
        id: 3,
        location: "Mirpur 10",
        latitude: 23.8067,
        longitude: 90.3686,
        area_type: "Transit Hub",
        reported_incidents: 15,
        safety_rating: "Low",
        notes: "Crowded, watch valuables.",
        patrolling: "Occasional",
        street_lighting: "Average",
        women_helpline: "109",
        transport_access: "Excellent",
        description: "Bus & metro hub.",
        last_updated: new Date().toISOString()
      }
    ];
    localStorage.setItem(LS_KEY, JSON.stringify(seed));
  }
})();

function readAll() {
  try { return JSON.parse(localStorage.getItem(LS_KEY)) || []; }
  catch(e){ return []; }
}

/* =========================================================
   2) Utilities: live clock & animate counters
   ========================================================= */
function updateClock() {
  const now = new Date();
  document.getElementById('liveClock').textContent =
    `ðŸ•’ ${now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'})}`;
}
setInterval(updateClock, 1000); updateClock();

function animateNumber(el, to, ms=900) {
  const $el = $(el);
  $({n:0}).animate({n:to},{
    duration: ms,
    easing: 'swing',
    step: function(){ $el.text(Math.floor(this.n)); },
    complete: function(){ $el.text(to); }
  });
}

/* =========================================================
   3) Map setup + layers + controls
   ========================================================= */
const map = L.map('map').setView([23.8103, 90.4125], 12);
const light = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
const dark  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap & CartoDB'
});

function colorForLevel(level) {
  const r = (level || '').toLowerCase();
  if (r === 'high') return 'green';
  if (r === 'moderate') return 'orange';
  return 'red';
}

let heatLayer = null;
let cluster = L.markerClusterGroup().addTo(map);

// mini toolbar (locate / fullscreen / heat)
const toolbar = L.control({ position: 'topleft' });
toolbar.onAdd = function() {
  const wrap = L.DomUtil.create('div', 'leaflet-bar');
  const btnLocate = L.DomUtil.create('button', '', wrap);
  btnLocate.innerHTML = 'ðŸ“'; btnLocate.title = 'Locate me';
  btnLocate.onclick = () => {
    navigator.geolocation.getCurrentPosition(pos => {
      const latlng = [pos.coords.latitude, pos.coords.longitude];
      map.setView(latlng, 15);
      L.marker(latlng).addTo(map).bindPopup("You're here").openPopup();
    });
  };
  const btnFull = L.DomUtil.create('button', '', wrap);
  btnFull.innerHTML = 'â›¶'; btnFull.title = 'Fullscreen';
  btnFull.onclick = () => {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
  };
  const btnHeat = L.DomUtil.create('button', '', wrap);
  btnHeat.innerHTML = 'ðŸ”¥'; btnHeat.title = 'Toggle Heatmap';
  btnHeat.onclick = () => {
    if (!heatLayer) return;
    if (map.hasLayer(heatLayer)) map.removeLayer(heatLayer);
    else heatLayer.addTo(map);
  };
  return wrap;
};
toolbar.addTo(map);

// legend
const legend = L.control({ position: 'bottomright' });
legend.onAdd = function () {
  const div = L.DomUtil.create('div', 'legend');
  div.innerHTML = '<strong>Safety Levels</strong><br>';
  div.innerHTML += '<i style="background:green"></i> High<br>';
  div.innerHTML += '<i style="background:orange"></i> Moderate<br>';
  div.innerHTML += '<i style="background:red"></i> Low<br>';
  return div;
};
legend.addTo(map);

// dark mode toggle
document.getElementById('dark-mode-toggle').addEventListener('click', () => {
  if (map.hasLayer(light)) { map.removeLayer(light); dark.addTo(map); document.body.classList.add('dark-mode'); }
  else { map.removeLayer(dark); light.addTo(map); document.body.classList.remove('dark-mode'); }
});

/* =========================================================
   4) â€œFeedâ€ functions (replace PHP feed & queries)
   ========================================================= */
function filterPoints({q, level} = {}) {
  const all = readAll();
  const qNorm = (q||'').trim().toLowerCase();
  const lvl = (level||'all').toLowerCase();

  return all.filter(p => {
    const inLevel = (lvl === 'all') || ((p.safety_rating||'').toLowerCase() === lvl);
    if (!qNorm) return inLevel;
    const hay = [
      p.location, p.area_type, p.notes, p.description, p.patrolling,
      p.street_lighting, p.transport_access
    ].map(x => (x||'').toLowerCase()).join(' ');
    return inLevel && hay.includes(qNorm);
  });
}

function computeStats(points) {
  const total = readAll().length; // total resources in â€œDBâ€
  const categories = new Set(points.map(p => p.area_type || '')).size;
  const distinct = new Set(points.map(p => p.location || '')).size;
  return { total, categories, distinct };
}

/* =========================================================
   5) Renderers: map (clusters + heat), counters, table
   ========================================================= */
function popupHTML(p) {
  return `
    <table class="table table-sm mb-0">
      <tr><th colspan="2">${p.location}</th></tr>
      <tr><td><b>Safety Level</b></td><td>${p.safety_rating}</td></tr>
      <tr><td><b>Area Type</b></td><td>${p.area_type ?? '-'}</td></tr>
      <tr><td><b>Incidents</b></td><td>${p.reported_incidents ?? 0}</td></tr>
      <tr><td><b>Patrolling</b></td><td>${p.patrolling ?? '-'}</td></tr>
      <tr><td><b>Street Lighting</b></td><td>${p.street_lighting ?? '-'}</td></tr>
      <tr><td><b>Women Helpline</b></td><td>${p.women_helpline ?? '109'}</td></tr>
      <tr><td><b>Transport Access</b></td><td>${p.transport_access ?? '-'}</td></tr>
      <tr><td><b>Notes</b></td><td>${p.description || p.notes || '-'}</td></tr>
      <tr><td><b>Last Updated</b></td><td>${p.last_updated ? new Date(p.last_updated).toLocaleString() : '-'}</td></tr>
    </table>
  `;
}

function renderMap(points) {
  cluster.clearLayers();
  const heatData = [];

  points.forEach(p => {
    const lat = parseFloat(p.latitude), lon = parseFloat(p.longitude);
    if (isNaN(lat) || isNaN(lon)) return;

    // intensity heuristic
    const lvl = (p.safety_rating || '').toLowerCase();
    const intensity = lvl === 'high' ? 0.6 : (lvl === 'moderate' ? 0.4 : 0.2);
    heatData.push([lat, lon, intensity]);

    const marker = L.circleMarker([lat, lon], {
      radius: 8,
      color: colorForLevel(p.safety_rating),
      fillColor: colorForLevel(p.safety_rating),
      fillOpacity: 0.85,
      weight: 1
    })
      .bindPopup(popupHTML(p))
      .bindTooltip(`${p.location} â€” ${p.safety_rating}`, {direction:'top', offset:[0,-8]});

    cluster.addLayer(marker);
  });

  if (heatLayer) map.removeLayer(heatLayer);
  heatLayer = L.heatLayer(heatData, { radius: 26, blur: 18 });
}

function renderCounters(points) {
  const { total, categories, distinct } = computeStats(points);
  animateNumber('#stat-total', total);
  animateNumber('#stat-categories', categories);
  animateNumber('#stat-distinct', distinct);
}

let dataTable;
function renderTable(points) {
  const tbody = document.getElementById('ratingsTbody');
  tbody.innerHTML = '';
  if (!points.length) {
    tbody.innerHTML = '<tr><td colspan="7">No data found</td></tr>';
  } else {
    const frag = document.createDocumentFragment();
    points
      .sort((a,b)=> (a.location||'').localeCompare(b.location||''))
      .forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHTML(row.location)}</td>
          <td>${escapeHTML(row.latitude)}</td>
          <td>${escapeHTML(row.longitude)}</td>
          <td>${escapeHTML(row.area_type || '-')}</td>
          <td>${escapeHTML(row.reported_incidents ?? 0)}</td>
          <td>${escapeHTML(row.safety_rating || '-')}</td>
          <td>${escapeHTML(row.notes || '-')}</td>
        `;
        frag.appendChild(tr);
      });
    tbody.appendChild(frag);
  }

  // (Re)initialize DataTable
  if (dataTable) {
    dataTable.clear().destroy();
  }
  dataTable = $('#ratingsTable').DataTable({
    responsive: true,
    dom: 'Bfrtip',
    buttons: ['csvHtml5', 'excelHtml5', 'pdfHtml5'],
    pageLength: 10
  });
}

function escapeHTML(x){
  return String(x===undefined||x===null?'':x)
    .replace(/[&<>"'`=\/]/g, s => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
    }[s]));
}

/* =========================================================
   6) Load + Filter handlers
   ========================================================= */
function loadAndRender(params = {}) {
  const pts = filterPoints(params);
  renderCounters(pts);
  renderMap(pts);
  renderTable(pts);
}

// initial
loadAndRender();

// filter buttons
document.getElementById('apply-filter').addEventListener('click', () => {
  const q = document.getElementById('search-input').value;
  const level = document.getElementById('filter-select').value;
  loadAndRender({ q, level });
});
document.getElementById('reset-filter').addEventListener('click', () => {
  document.getElementById('search-input').value = '';
  document.getElementById('filter-select').value = 'all';
  loadAndRender();
});
</script>
</body>
</html>